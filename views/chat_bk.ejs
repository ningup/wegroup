<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="Keywords" content="微群助手－主页" />
    <meta name="Description" content="微信公众平台上的公众号－－微群助手" />
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>微群帮手测试</title>

    <!-- Bootstrap -->
    <!--<link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.css">-->
    <link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/stylesheets/weui.css">
    <script language="javascript" type="text/javascript" src="/javascript/jquery.min.js"></script>
    <!--<script language="javascript" type="text/javascript" src="/javascript/bootstrap.js"></script>-->
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
    <script type="text/javascript">
        AV.initialize('DKHKFtC7GKQ73o88sUgyEEON', 'vjB7pWwwzSYaaze1nrgwXYWL');
    </script>

    <script type="text/javascript" src="/bower_components/leancloud-realtime/dist/AV.realtime.js"></script>
    <script type="text/javascript" src="/javascript/jquery.qqFace.js"></script>

    <style type="text/css">
    body {background-color: #FBFBFB;}

    .chat-thread {
      margin: 24px auto 68px auto;
      padding: 0 5px 0 5px;
      list-style: none;
      overflow-y: scroll;
      overflow-x: hidden;
    }

    .chat-thread li {
      position: relative;
      clear: both;
      display: inline-block;
      padding: 16px 40px 16px 20px;
      margin: 0 0 20px 0;
      font: 16px/20px 'Noto Sans', sans-serif;
      border-radius: 10px;
      background-color: rgba(25, 147, 147, 0.2);
    }
    .chat-thread li>img{float: left;width: 150px;height: 150px;}
    img.emoji{float: none;width: 24px;height: 24px;}

    /* Chat - Avatar */
    .chat-thread li:before {
      position: absolute;
      top: 0;
      width: 50px;
      height: 50px;
      border-radius: 50px;
      content: '';
    }

    /* Chat - Speech Bubble Arrow */
    .chat-thread li:after {
      position: absolute;
      top: 15px;
      content: '';
      width: 0;
      height: 0;
      border-top: 15px solid rgba(25, 147, 147, 0.2);
    }

    .chat-thread li.me {
      animation: show-chat-odd 0.15s 1 ease-in;
      -moz-animation: show-chat-odd 0.15s 1 ease-in;
      -webkit-animation: show-chat-odd 0.15s 1 ease-in;
      float: right;
      margin-right: 65px;
      margin-left: 50px;
      color: #0AD5C1;
    }

    .chat-thread li.me:before {
      right: -65px;
    }

    .chat-thread li.me:after {
      border-right: 10px solid transparent;
      right: -10px;
    }

    .chat-thread li.others {
      animation: show-chat-even 0.15s 1 ease-in;
      -moz-animation: show-chat-even 0.15s 1 ease-in;
      -webkit-animation: show-chat-even 0.15s 1 ease-in;
      float: left;
      margin-left: 65px;
      margin-right: 50px;
      margin-top: 20px;
      color: #0EC879;
    }

    .chat-thread li.others:before {
      left: -65px;
      top: -20px;
    }

    .chat-thread li.others:after {
      border-left: 10px solid transparent;
      left: -10px;
    }
    .chat-thread li.others .user_name{
      position: absolute;
      height: 20px;
      left: 0;
      top: -20px;
      line-height: 20px;
      font-size: 15px;
      color: #BEBFC3;
    }


    .publish{position: fixed;left: 0;bottom: 0;width: 100%;z-index: 2;background-color: #f8f8f8;}
    .publish:before{z-index: 2;top: -1px;display: block;position: absolute;left: 0;border-top: 1px solid #c8c7cc;width: 100%;content: " ";pointer-events:none;}
    .publish .pub-con .pub-wrap {position: relative;width: 100%;height: 68px;padding: 0 80px 0 90px;}
    .publish .pub-con .pub-wrap button{position: absolute;top: 4px;right: 5px; border: 0;border-radius: 4px;width: 70px;height: 35px;font-size: 16px; text-align: center;color: #fff; background-color: #2791dc;outline: 0;-webkit-tap-highlight-color: rgba(255,255,255,0);padding: 0;margin: 0;font: 11px BlinkMacSystemFont;text-rendering: auto;letter-spacing: normal;word-spacing: normal;text-transform: none;text-indent: 0px;text-shadow: none;display: inline-block;}
    .publish .pub-con .pub-wrap>textarea{position: relative;width: 100%;top: 4px;height: 60px;border-radius: 4px;outline:0; resize:none;box-shadow:0;border-style: solid;border-color:#c8c7cc;border: 1;margin: 0 80px 0 0;font-size: 16px;line-height: 20px; }
    .publish .pub-con .pub-wrap .photo{position: absolute; left: 0; margin: 0;width: 44px;height: 44px;background: transparent url(/images/a6b.png) no-repeat 5px 5px;background-size: 34px 34px;}
    .publish .pub-con .pub-wrap .photo>input{position: absolute;top: 0;left: 0;width: 100%;height: 100%;opacity: 0;cursor: pointer;}
    .publish .pub-con .pub-wrap .biaoqing{position: absolute; left: 44px; margin: 0;width: 44px;height: 44px;background: transparent url(/images/sz.png) no-repeat 5px 5px;background-size: 34px 34px;}
    #facebox{/*style="position:absolute;display:none;z-index:1000;"*/position: fixed;left: 0;width: 100%;bottom: 68px;background-color: #f8f8f8;z-index:2;display: none;}
    </style>

  </head>
  <body>
    <div id="convo" data-from="Sonu Joshi">  
      <ul class="chat-thread">
        
      </ul>
    </div>
    <div class="publish" id="myModal">
        <div class="pub-con">
            <div class="pub-wrap">
              <div class="photo"><input id="inputField" class="upload_photo" type="file" accept="image/*" multiple> </div>
              <div class="biaoqing"></div>
              <textarea spellcheck="false" type="text" class="editor" placeholder="我也来说一句...." style="" id="saytext" name="saytext"> </textarea>
              <button class="pub-publish">发表</button>
            </div>
        </div>
    </div>
    <script type="text/javascript">
      //实时通信test
      var appId = "DKHKFtC7GKQ73o88sUgyEEON";
      var clientId = '<%= username%>';
      var roomId = '<%= roomId%>';
      var realtimeObj;
      var conversationObj;
      var msgTime;
      var pre_height = 0;
      var log_flag = 1;
      var printWall = $("#convo");
      realtimeObj = AV.realtime({
          appId: appId,
          clientId: clientId,
          // 是否开启 HTML 转义，SDK 层面开启防御 XSS
          encodeHTML: true
          // 是否开启服务器端认证
          // auth: authFun,
          // 是否使用其他地区的节点
          // region: 'us'
      });

      // 当前 SDK 版本
      console.log('当前 SDK 版本是 ' + AV.realtime.version);

      realtimeObj.on('open', function() {
          console.log('实时通信服务建立成功！');

          // 创建一个聊天室，conv 是 conversation 的缩写，也可以用 room 方法替换
          conversationObj = realtimeObj.conv(roomId, function(object) {
              if (object) {
                  //conversationObj ＝ object;
                  console.log('Conversation 创建成功!', object);
                  console.log(conversationObj);


              //conversationObj.add("username4", function(){
              //  console.log("增加成员");
              //})

              conversationObj.join(function(){
                console.log("加入了群聊");
              });
              conversationObj.log(function(data){
                if (data&&(data.length>0)) {
                  msgTime = data[0].timestamp;
                  console.log(msgTime);
                  console.log(data);
                  var cnt = 0;
                  for(var i = 0;i<data.length;i++){
										(function(i){
												var username = data[i].fromPeerId;
												//alert(username);
												var query = new AV.Query(AV.User);
												query.equalTo("username", username);
												query.first({
													success: function(queryUser) {
															var others_nickname = queryUser.get('nickname');
															//alert(others_nickname);
															var others_headimgurl = queryUser.get('headimgurl');
															//alert(others_headimgurl);
															if (data[i].fromPeerId!=clientId) {
															//var others_name = data[i].fromPeerId;
															if (data[i].msg.type == 'text') {
																var others_text = data[i].msg.text;
																//alert(replace_em(others_text));
																var str = "<li class=\"others " + username + " \">"+ "<span class=\"user_name\">"+ others_nickname +"</span>" + replace_em(others_text) +"</li>";
															}else if(data[i].msg.type == 'image'){
																var others_url = data[i].msg.url;
																var img_str = "<img src=\"" + others_url + "\" >";
																var str = "<li class=\"others " + username + " \">"+ "<span class=\"user_name\">"+ others_nickname +"</span>" + img_str +"</li>";
															}
															$(".chat-thread").append(str);
															var str = "<style>li." + username + ":before{ background-image: url(" + others_headimgurl + "); }</style>";
															$('head').append(str);
														}else{
															if (data[i].msg.type == 'text') {
																var str = "<li class=\"me " + username + " \">"+ replace_em(data[i].msg.text) +"</li>";
															}else if (data[i].msg.type == 'image') {
																var others_url = data[i].msg.url;
																var img_str = "<img src=\"" + others_url + "\" >";
																var str = "<li class=\"me " + username + " \">"+ img_str +"</li>";
															}
															$(".chat-thread").append(str);	
															var str = "<style>li." + username + ":before{ background-image: url(" + others_headimgurl + "); }</style>";
															$('head').append(str);
														}	
														cnt ++;
														if(cnt == data.length){
															//alert(cnt);
															$(document).scrollTop(printWall.height());
															pre_height = printWall.height();
														}
													},
													error: function(error) {
													} 
												});
										})(i);
                    
                  }
                  //$(document).scrollTop(printWall[0].scrollHeight);
                  //$(document).scrollTop(printWall.height());
                  //pre_height = printWall.height();
                }else{ log_flag = 0; }
              });
              
              // 房间接受消息
              conversationObj.receive(function(data) {
                //if (!msgTime) {
                  // 存储下最早的一个消息时间戳
                  //msgTime = data.timestamp;
                //}
                //console.log(data);
                //console.log("收到");
                var others_name = data.fromPeerId;
                var query = new AV.Query(AV.User);
								query.equalTo("username", others_name);
								query.first({
									success: function(queryUser) {
										var others_nickname = queryUser.get('nickname');
										var others_headimgurl = queryUser.get('headimgurl');
										alert(others_headimgurl);
										if (data.msg.type == "text") {
											var others_text = data.msg.text;
											var str = "<li class=\"others " + others_name + " \">"+ "<span class=\"user_name\">"+ others_nickname +"</span>" + replace_em(others_text) +"</li>";
											$(".chat-thread").append(str);
											var str = "<style>li." + others_name + ":before{ background-image: url(" + others_headimgurl + "); }</style>";
											$('head').append(str);
											$(document).scrollTop(printWall.height());
											pre_height = printWall.height();
										}else if (data.msg.type == "image") {
											var others_url = data.msg.url;
											var img_str = "<img src=\"" + others_url + "\" >";
											var str = "<li class=\"others " + others_name + " \">"+ "<span class=\"user_name\">"+ others_nickname +"</span>" + img_str + "</li>";
											$(".chat-thread").append(str);
											var str = "<style>li." + others_name + ":before{ background-image: url(" + others_headimgurl + "); }</style>";
													$('head').append(str);
											$(document).scrollTop(printWall.height());
											pre_height = printWall.height();
										}
									},
									error: function(error) {
									} 
								});
                
              });
              }
          });
      });

      // 当聊天断开时触发
      /*realtimeObj.on('close', function() {
          console.log('实时通信服务被断开！');
      });*/

      // 接收断线或者网络状况不佳的事件（断网可测试）
      /*realtimeObj.on('reuse', function() {
          console.log('正在重新连接。。。');
      });*/

      // 当 Conversation 被创建时触发，当然你可以使用回调函数来处理，不一定要监听这个事件
      /*realtimeObj.on('create', function(data) {

          // 向这个 Conversation 添加新的用户
          console.log("创建一个聊天室，conv");
      });*/

      // 监听所有用户加入的情况
      /*realtimeObj.on('membersjoined', function(data) {
          console.log('有用户加入某个当前用户在的 Conversation：', data);
      });*/

      // 监听所有用户离开的情况
      /*realtimeObj.on('membersleft', function(data) {
          console.log('有用户离开某个当前用户在的 Conversation：', data);
      });*/

      // 监听所有 Conversation 中发送的消息
      /*realtimeObj.on('message', function(data) {
          console.log('某个当前用户在的 Conversation 接收到消息：', data);
      });*/
    </script>
    <script type="text/javascript">
      $(".pub-publish").click(function(){
        var send = $(".editor").val();
        $(".editor").val("");
        //alert(send);
        conversationObj.send({
          text: send
        }, {
          type: 'text'
        }, function(data) {
          //alert(send);
          // 发送成功之后的回调
          var str = "<li class=\"me\">"+ replace_em(send) +"</li>";
          $(".chat-thread").append(str);

          $(document).scrollTop(printWall.height());
          pre_height = printWall.height();
        });
      });

      $(document).scroll(function(){
        if (($(document).scrollTop() < 20)&&(log_flag==1)) {
          conversationObj.log({t:msgTime},function(data){
            console.log(data);
            if (data&&(data.length>0)) {
                  msgTime = data[0].timestamp;
                  //console.log(msgTime);
                  //console.log(data);
                  var cnt = 0;
                  for(var i = (data.length-1);i>=0;i--){
										(function(i){
											var username = data[i].fromPeerId;
											var query = new AV.Query(AV.User);
											query.equalTo("username", username);
											query.first({
												success: function(queryUser) {
														var others_nickname = queryUser.get('nickname');
														var others_headimgurl = queryUser.get('headimgurl');
														if (data[i].fromPeerId!=clientId) {
														var others_name = data[i].fromPeerId;
														if (data[i].msg.type == 'text') {
															var others_text = data[i].msg.text;
															var str = "<li class=\"others " + username + " \">"+ "<span class=\"user_name\">"+ others_nickname +"</span>" + replace_em(others_text) +"</li>";
														}else if(data[i].msg.type == 'image'){
															var others_url = data[i].msg.url;
															var img_str = "<img src=\"" + others_url + "\" >";
															var str = "<li class=\"others " + username + " \">"+ "<span class=\"user_name\">"+ others_nickname +"</span>" + img_str +"</li>";
														}
														$(".chat-thread").prepend(str);
														var str = "<style>li." + username + ":before{ background-image: url(" + others_headimgurl + "); }</style>";
													$('head').append(str);
													}else{
														if (data[i].msg.type == 'text') {
															var str = "<li class=\"me " + username + " \">"+ replace_em(data[i].msg.text) +"</li>";
														}else if (data[i].msg.type == 'image') {
															var others_url = data[i].msg.url;
															var img_str = "<img src=\"" + others_url + "\" >";
															var str = "<li class=\"me " + username + " \">"+ img_str +"</li>";
														}
														$(".chat-thread").prepend(str);
														var str = "<style>li." + username + ":before{ background-image: url(" + others_headimgurl + "); }</style>";
													$('head').append(str);
													}
													cnt ++;
														if(cnt == data.length){
															//alert(cnt);
															$(document).scrollTop($("#convo").height()-pre_height);
															pre_height = $("#convo").height();
														}
												},
												error: function(error) {
												} 
											});
										
										})(i);
                  }
                  //$(document).scrollTop($("#convo").height()-pre_height);
                  //pre_height = $("#convo").height();
            }else{ log_flag = 0; }
          })
        }
      });
    </script>
    <script type="text/javascript">
        var inputElement = document.getElementById("inputField");
        inputElement.addEventListener("change", handleFiles, false);
        function handleFiles() {
            var fileList = this.files; 
            if (fileList.length>0) {
                if (fileList.length>8) {
                    alert("一次最多上传8张图片");
                    for (var i = 0; i < 8; i++) {
                        var file = fileList[i];
                        var img_str = "<img src=\"\" "+ "class=\""+ "input_img_flag" +"\"" +">";
                        var str = "<li class=\"me\">"+ img_str +"</li>";
                        $(".chat-thread").append(str);

                        $(document).scrollTop(printWall.height());
                        pre_height = printWall.height();

                        var name = file.name;
                        var avFile = new AV.File(name,file);
                        avFile.save().then(function(avFile){
                            var src = avFile.url();
                            if($("img.input_img_flag").length>0){
                              $("img.input_img_flag:first").attr("src",src);
                              $("img.input_img_flag:first").attr("class","");
                            }
                            conversationObj.send({
                              text:"ceshi",
                              attr:{},
                              url: src,
                              metaData:{}
                            }, {
                              type: 'image'
                            }, function(data) {
                              
                            });
                        });
                    };
                }else{
                    for (var i = 0; i < fileList.length; i++) {
                        var file = fileList[i];
                        var img_str = "<img src=\"\" "+ "class=\""+ "input_img_flag" +"\"" +">";
                        var str = "<li class=\"me\">"+ img_str +"</li>";
                        $(".chat-thread").append(str);

                        $(document).scrollTop(printWall.height());
                        pre_height = printWall.height();

                        var name = file.name;
                        var avFile = new AV.File(name,file);
                        avFile.save().then(function(avFile){
                            var src = avFile.url();
                            if($("img.input_img_flag").length>0){
                              console.log("hello world");
                              $("img.input_img_flag:first").attr("src",src);
                              $("img.input_img_flag:first").attr("class","");
                            }
                            conversationObj.send({
                              text:"ceshi",
                              attr:{},
                              url: src,
                              metaData:{}
                            }, {
                              type: 'image'
                            }, function(data) {
                              
                            });
                        });
                    };
                }
            }
        }
    </script>
    <script type="text/javascript">
      $(function(){
        $('.biaoqing').qqFace({
          id : 'facebox', //表情盒子的ID
          assign:'saytext', //给那个控件赋值
          path:'/images/face/'  //表情存放的路径
        });
        //$(".sub_btn").click(function(){
        //  var str = $("#saytext").val();
        //  $("#show").html(replace_em(str));
        //});
      });
      //查看结果
      function replace_em(str){
        str = str.replace(/\</g,'&lt;');
        str = str.replace(/\>/g,'&gt;');
        str = str.replace(/\n/g,'<br/>');
        str = str.replace(/\[em_([0-9]*)\]/g,'<img src="/images/face/$1.gif" border="0" class="emoji" style="float: none;width: 24px;height: 24px;"/>');
        return str;
      }
    </script>
  </body>
</html>
