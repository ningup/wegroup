<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta name="Keywords" content="微群助手－主页" />
    <meta name="Description" content="微信公众平台上的公众号－－微群助手" />
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>微群帮手测试</title>

    <!-- Bootstrap -->
    <!--<link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.css">-->
    <link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/stylesheets/weui.css">
    <script language="javascript" type="text/javascript" src="/javascript/jquery.min.js"></script>
    <!--<script language="javascript" type="text/javascript" src="/javascript/bootstrap.js"></script>-->
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/iScroll/5.1.3/iscroll-probe.min.js"></script>

    <style type="text/css">
    body {background-color: #FBFBFB;}
    #wrapper {position: absolute;overflow: hidden;left: 0;top: 0;bottom: 0;width: 100%;z-index: 1;}
    .container {position: relative;padding: 0;}
    .vote-feed {background-color: #FFFFFF;margin-top: 10px;}
    .vote-user {position: relative;width: 100%;height: 50px;}
    .vote-user img{position: absolute;top: 10px;left: 10px;width: 30px;height: 30px;border-radius: 15px;}
    .vote-user .username {position: absolute;top: 10px;left: 45px;font-size: 10px;color: #0080FF;}
    .vote-user .time {position: absolute;top: 25px;left: 45px;font-size: 5px;color: #7A7A7A;}
    .vote-content .content {width: 100%;padding-left: 10px;padding-right: 10px;padding-top: 10px;padding-bottom: 10px; position: relative;font-size: 14px;line-height: 18px;}
    .vote-content .xuanxiang div {color: #0080FF;text-align: center;position: relative;height: 40px;font-size: 10px;line-height: 40px;}
    .vote-content .content:before {
        content: " ";
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 1px;
        border-top: 1px solid #ECECEC;
        transform-origin: 0 100%;
        transform:scaleY(0.5);
    }
    .vote-content .xuanxiang div:before {
        content: " ";
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 1px;
        border-top: 1px solid #ECECEC;
        transform-origin: 0 100%;
        transform:scaleY(0.5);
    }
    .vote-feed .vote-info .sum {font-size: 7px;color: #7A7A7A;margin-top: 5px;width: 100%;margin-left: 10px;margin-right: 10px;}
    .vote-new {position: fixed;left: 0px;bottom: 0px; width: 100%;height: 40px; background-color: #dedede;font-size:20px;
        text-align: center;line-height:40px;color: #7A7A7A;border-width: 0 0 0 0;z-index: 100;}
    .ok .vote-content .xuanxiang div {position: relative;color: #7A7A7A;}
    .ok .vote-content .xuanxiang div .n{position: absolute;top:0;left: 0; height: 40px;font-size: 10px;line-height: 40px;width: 100%;text-align: center;}
    .ok .vote-content .xuanxiang div .b{position: absolute;top:0; right: 10px; height: 40px;font-size: 10px;line-height: 40px;}
    .ok .vote-content .xuanxiang .user-click {color: #000000;font-weight: 900;}
    .ok .vote-content .xuanxiang div .percent {position: relative;height: 100%;background-color: #dedede;}
    .ok .vote-content .xuanxiang .user-click .percent{position: relative;height: 100%;background-color: #00ccff;}
    .modal .modal-dialog .modal-content .header{position: relative;width: 100%;height: 30px;}
    .modal .modal-dialog .modal-content .header .vote-close {position: absolute;top: 0px;left: 0px;height: 100%;line-height: 30px;padding-left: 10px;}
    .modal .modal-dialog .modal-content .header .vote-ok {position: absolute;top: 0px;right: 0px;height: 100%;line-height: 30px;padding-right: 10px;}
    .modal .modal-dialog .modal-content .body textarea {width: 100%; height: 150px;border-width: 0;margin-top: 10px;margin-bottom: 10px;}
    .modal .modal-dialog .modal-content .body input {width: 100%; height: 40px;border-width: 0;background-color: #dedede;color: #7A7A7A;text-align: center;line-height: 40px;margin-bottom: 1px;}
    .modal .modal-dialog .modal-content .footer button {width: 100%;height: 40px;font-size:20px;text-align: center;line-height:40px;color: #0080FF;border-width: 0;background-color: #FFFFFF;}
    </style>

  </head>
  <body>
    <div id="wrapper">
      <div class="container">
  	<% for(var i=0; i<votes.length; i++) {
  		if(votes[i].get('voteResults').voteResults.voteItemContent.itemResults!=null){
        var itemresults = votes[i].get('voteResults').voteResults.voteItemContent.itemResults;
        var flag = 0;
        var choicewhat ;
        for(var j=0;j<itemresults.length;j++){
        	if (itemresults[j].username==username) {
        		flag = 1;
        		choicewhat = itemresults[j].choice;
        	}
        } 
 
        if(flag==0){ %>
    <div class="vote-feed" data-feedid="<%= votes[i].getObjectId()%>">
        <div class="vote-user">
            <img src="<%= votes[i].get('userHeadImgUrl')%>">
            <div class="username"><%= votes[i].get('nicknameOfPUser')%></div>
            <%var date = new Date();
            var year = date.getFullYear() - votes[i].getCreatedAt().getFullYear();
            var month = date.getMonth() - votes[i].getCreatedAt().getMonth();
            var day = date.getDate() - votes[i].getCreatedAt().getDate();
            var hours = date.getHours() - votes[i].getCreatedAt().getHours();
            var minute = date.getMinutes() - votes[i].getCreatedAt().getMinutes();
            var last_time = "";
            if(year>0){
                last_time= year + "年前";
            }else if(month>0){
                last_time= month + "月前";
            }else if(day>0){
                last_time= day + "天前";
            }else if(hours>0){
                last_time= hours + "小时前";
            }else if(minute>0){
                last_time= minute + "分钟前";
            }else{
                last_time= "刚刚";
            }%>
            <div class="time"><%= last_time%></div>
        </div>
        <div class="vote-content">
            <div class="content"><%= votes[i].get('voteContent').voteContent.voteDecription%></div>
            <div class="xuanxiang">
                <% for(var y=0;y<votes[i].get('voteContent').voteContent.choiceItem.length;y++){%>
                <div class="">
                    <span id="<%= y%>"><%= votes[i].get('voteContent').voteContent.choiceItem[y]%></span>
                </div>
                <% } %>
            </div>
        </div>
        <div class="vote-info">
            <div class="sum"><%= votes[i].get('voteCnt')%>人参与</div>
        </div>
    </div>
    <% } else{%>
    <div class="vote-feed ok" data-feedid="<%= votes[i].getObjectId()%>">
        <div class="vote-user">
            <img src="<%= votes[i].get('userHeadImgUrl')%>">
            <div class="username"><%= votes[i].get('nicknameOfPUser')%></div>
            <%var date = new Date();
            var year = date.getFullYear() - votes[i].getCreatedAt().getFullYear();
            var month = date.getMonth() - votes[i].getCreatedAt().getMonth();
            var day = date.getDate() - votes[i].getCreatedAt().getDate();
            var hours = date.getHours() - votes[i].getCreatedAt().getHours();
            var minute = date.getMinutes() - votes[i].getCreatedAt().getMinutes();
            var last_time = "";
            if(year>0){
                last_time= year + "年前";
            }else if(month>0){
                last_time= month + "月前";
            }else if(day>0){
                last_time= day + "天前";
            }else if(hours>0){
                last_time= hours + "小时前";
            }else if(minute>0){
                last_time= minute + "分钟前";
            }else{
                last_time= "刚刚";
            }%>
            <div class="time"><%= last_time%></div>
        </div>
        <div class="vote-content">
            <div class="content"><%= votes[i].get('voteContent').voteContent.voteDecription%></div>
            <div class="xuanxiang">
            	<% for(var y=0;y<votes[i].get('voteContent').voteContent.choiceItem.length;y++){
            		if(choicewhat==y){ %>
                <div class="user-click">
                    <div class="percent" style="width:<%= votes[i].get('voteResults').voteResults.voteItemContent.choiceItem[y].percent%>%;"></div>
                    <span class="n" id="<%= y%>"><%= votes[i].get('voteContent').voteContent.choiceItem[y]%></span>
                    <span class="b" id="<%= y%>"><%= votes[i].get('voteResults').voteResults.voteItemContent.choiceItem[y].percent%>%</span>
                </div>
                <% }else{%>
                <div class="">
                    <div class="percent" style="width:<%= votes[i].get('voteResults').voteResults.voteItemContent.choiceItem[y].percent%>%;"></div>
                    <span class="n" id="<%= y%>"><%= votes[i].get('voteContent').voteContent.choiceItem[y]%></span>
                    <span class="b" id="<%= y%>"><%= votes[i].get('voteResults').voteResults.voteItemContent.choiceItem[y].percent%>%</span>
                </div>
                <% } %>
                <% } %>
            </div>
        </div>
        <div class="vote-info">
            <div class="sum"><%= votes[i].get('voteCnt')%>人参与</div>
        </div>
    </div>
    <% } %>
    <% }else{ %>
		<p>lalalalallalalalala</p>
    	<div class="vote-feed" data-feedid="<%= votes[i].getObjectId()%>">
	        <div class="vote-user">
	            <img src="<%= votes[i].get('userHeadImgUrl')%>">
	            <div class="username"><%= votes[i].get('nicknameOfPUser')%></div>
                <%var date = new Date();
                var year = date.getFullYear() - votes[i].getCreatedAt().getFullYear();
                var month = date.getMonth() - votes[i].getCreatedAt().getMonth();
                var day = date.getDate() - votes[i].getCreatedAt().getDate();
                var hours = date.getHours() - votes[i].getCreatedAt().getHours();
                var minute = date.getMinutes() - votes[i].getCreatedAt().getMinutes();
                var last_time = "";
                if(year>0){
                    last_time= year + "年前";
                }else if(month>0){
                    last_time= month + "月前";
                }else if(day>0){
                    last_time= day + "天前";
                }else if(hours>0){
                    last_time= hours + "小时前";
                }else if(minute>0){
                    last_time= minute + "分钟前";
                }else{
                    last_time= "刚刚";
                }%>
	            <div class="time"><%= last_time%></div>
	        </div>
	        <div class="vote-content">
	            <div class="content"><%= votes[i].get('voteContent').voteContent.voteDecription%></div>
	            <div class="xuanxiang">
	                <% for(var y=0;y<votes[i].get('voteContent').voteContent.choiceItem.length;y++){%>
	                <div class="">
	                    <span id="<%= y%>"><%= votes[i].get('voteContent').voteContent.choiceItem[y]%></span>
	                </div>
	                <% } %>
	            </div>
	        </div>
	        <div class="vote-info">
	            <div class="sum"><%= votes[i].get('voteCnt')%>人参与</div>
	        </div>
	    </div>
    <% } %>
    <% } %>
        </div>
    </div>
    <button class="vote-new" type="button" data-toggle="modal" data-target="#myModal">发起投票</button>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="header">
            <span class="vote-close" data-dismiss="modal" aria-label="Close">关闭</span>
            <span class="vote-ok" id="myModalLabel">完成</span>
          </div>
          <div class="body">
            <form id="voteform" method="post" action="/feed/post">
                <textarea placeholder="请填写你的问题..." autofocus name="voteDecription"></textarea>
                <input type="text" class="" placeholder="选项1" id="1" name="choiceTitle" />
                <input type="text" class="" placeholder="选项2" id="2" name="choiceTitle" />
                <input type="hidden" value="<%=username%>" name="username" />
                <input type="hidden" value="vote" name="feedType" >
            </form>
          </div>
          <div class="footer">
            <button type="button" class="">增加一个选项</button>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
        $(function(){
            $(".modal .modal-dialog .modal-content .footer button").click(function(){
                var max = 2;
                var i = 0;
                $(".modal .modal-dialog .modal-content .body input").each(function(){
                    var temp = $(this).attr("id");
                    if (temp!=null) {
                        if (temp>max) {max = temp;};
                        i++;
                    }
                });
                if (i<10) {
                    max++;
                    var str = "<input type=\"text\" class=\"\" placeholder=\"选项"+ max +"\" "+" id=\"" + max + "\" "+" name=\"choiceTitle\" "+" />";
                    $(".modal .modal-dialog .modal-content .body #voteform").append(str);
                }else {alert("最多只有10个选项");}
            });
            $("#myModal").on('hidden.bs.modal',function(){
                var tempstr = "<textarea placeholder=\"请填写你的问题...\" autofocus></textarea><input type=\"text\" class=\"\" placeholder=\"选项1\" id=\"1\" /><input type=\"text\" class=\"\" placeholder=\"选项2\" id=\"2\" />";
                $(".modal .modal-dialog .modal-content .body #voteform").html(tempstr);

            });
            $(".modal .modal-dialog .modal-content .header .vote-ok").click(function(){
            	var i = 0;
                var flag = 0;
                var texttemp = $(".modal .modal-dialog .modal-content .body textarea").val();
                //alert(texttemp);
                if (texttemp.length!=0) {flag=1;}
                //alert(flag);
                $(".modal .modal-dialog .modal-content .body input").each(function(){
                	var temptemp = $(this).attr("id");
                	if (temptemp!=null) {
	                    var temp = $(this).val();
	                    //alert(temp);
	                    if (temp.length!=0) {i++;}
                	}
                });
                if((i>=2)&&flag){
                    $("#voteform").submit();
                    $('#myModal').modal('hide');
                }else{
                    if (flag==0) {
                        alert("投票内容不能为空");
                    }else{
                        alert("最少需要填写两个选项");
                    }
                }
            });
            $(".vote-content .xuanxiang > div").click(function(){
				//alert("click OK");
            	var feed = $(this).closest(".vote-feed");
            	var flag = 0;
            	var clicknum;
            	var feedid = feed.attr("data-feedid");
            	if(feed.hasClass("ok")){
						flag=1;alert("已经点过了");
				}
            	if (flag==0) {
            		clicknum = $(this).children("span").attr("id");
            		$.ajax({
            			url:"/feed/vote",
            			data:{
            				"username":"<%= username%>",
            				"feedObjId":feedid,
            				"choiceId":clicknum
            			},
            			type:"post",
            			dataType:"json",
            			success:function(data){
            				var feedObjId = data.feedObjId;
            				var choiceId = data.choiceId;
            				var cw = 0;
            				$(".vote-feed").each(function(){
            					if (feedObjId==$(this).attr("data-feedid")) {
									//alert("匹配");
            						var choicesum = $(this).find(".vote-content .xuanxiang>div");
            						$(this).addClass("ok");
            						//alert($(this).attr("class"));
            						choicesum.each(function(){
										
            							if ($(this).find("span").attr("id")==choiceId) {
            								$(this).addClass("user-click");
            								$(this).find("span").addClass("n");
            								var idb = $(this).find("span").attr("id");
            								var spanstr = "<span class=\"b\" id=\""+idb+"\">"+data.voteResultsWithoutUser.voteResultsWithoutUser.voteItemContent.choiceItem[cw].percent+"%</span>";
            								$(this).prepend("<div class=\"percent\" style=\"width:"+data.voteResultsWithoutUser.voteResultsWithoutUser.voteItemContent.choiceItem[cw].percent+"%;\"></div>");
            								$(this).append(spanstr);
            							}else{
            								$(this).find("span").addClass("n");
            								var idb = $(this).find("span").attr("id");
            								var spanstr = "<span class=\"b\" id=\""+idb+"\">"+data.voteResultsWithoutUser.voteResultsWithoutUser.voteItemContent.choiceItem[cw].percent%>+"%</span>";
            								$(this).prepend("<div class=\"percent\" style=\"width:"+data.voteResultsWithoutUser.voteResultsWithoutUser.voteItemContent.choiceItem[cw].percent+"%;\"></div>");
            								$(this).append(spanstr);
            							}
            							cw++;
            						});
            					}
            				});
            			},
            			error:function(){alert("敢run进来让你死");}
            		});
            	}
            });
        });
    </script>
    <script type="text/javascript">
        var myScroll;
        var position;
        var flag = 0;
        var page = 0;
        var last_position = 0;
        window.onload = function(){
            myScroll = new IScroll('#wrapper', { probeType: 3, mouseWheel: true, click:true, tap:true , preventDefaultException:{ tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT)$/ }  });
            myScroll.on("scroll", updataPosition);
            myScroll.on("scrollEnd", dowmPosition);
            document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
        };
        function updataPosition(){
            if (this.y>5) {
                flag = 1;
                //console.log(flag);
            //}else if(this.y<(this.maxScrollY-5)){
            }else if(this.y<=this.maxScrollY){
                flag = 2;
                //console.log(flag);
            }
            if (this.y<=0) {
                if ((this.y-last_position)>=0) {
                    $(".publish-btn").css("display","block");
                    last_position = this.y;
                }else{
                    $(".publish-btn").css("display","none");
                    last_position = this.y;
                }
            }else{
                $(".publish-btn").css("display","block");
                last_position = 0;
            }
        }
        function dowmPosition(){
            if (flag==1) {
                console.log("下拉加载");
                myScroll.refresh();
                flag = 0;
            }else if (flag==2) {
                console.log("上拉加载");
                /*for(var i=0;i<20;i++){
                    $(".container ul").append("<li>Pretty row 50</li>");
                }*/
                myScroll.refresh();
                flag = 0;
            }else{
                myScroll.refresh();
                flag = 0;
            }
        }
    </script>
  </body>
</html>
